#!/bin/bash
# Pre-merge commit hook to validate Dockerfile changes
# This hook prevents merging if the Dockerfile is invalid

set -e

DOCKERFILE="images/dbt-core/Dockerfile"
DBT_VERSION_FILE="images/dbt-core/versions/dbt-core.txt"

# Check if Dockerfile exists
if [ ! -f "$DOCKERFILE" ]; then
    echo "‚ùå Error: Dockerfile not found at $DOCKERFILE"
    exit 1
fi

echo "üîç Validating Dockerfile..."

# Check for required ARG statements
if ! grep -q "ARG PYTHON_VERSION_FILE" "$DOCKERFILE"; then
    echo "‚ùå Error: PYTHON_VERSION_FILE argument not found in Dockerfile"
    exit 1
fi

if ! grep -q "ARG DBT_VERSION_FILE" "$DOCKERFILE"; then
    echo "‚ùå Error: DBT_VERSION_FILE argument not found in Dockerfile"
    exit 1
fi

# Check for required stages
if ! grep -q "AS base" "$DOCKERFILE"; then
    echo "‚ö†Ô∏è  Warning: 'base' stage not found in Dockerfile"
fi

if ! grep -q "AS selector" "$DOCKERFILE"; then
    echo "‚ö†Ô∏è  Warning: 'selector' stage not found in Dockerfile"
fi

# Validate dbt version file exists
if [ ! -f "$DBT_VERSION_FILE" ]; then
    echo "‚ùå Error: dbt-core version file not found at $DBT_VERSION_FILE"
    exit 1
fi

DBT_VERSION=$(cat "$DBT_VERSION_FILE" | tr -d '\n' | xargs)
if [ -z "$DBT_VERSION" ]; then
    echo "‚ùå Error: dbt-core version file is empty"
    exit 1
fi

echo "‚úì Dockerfile validation passed"
echo "‚úì dbt-core version: $DBT_VERSION"
exit 0
